<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout.html}">

<head>
</head>

<body>

    <i layout:fragment="icon" class="bi bi-bookmark logo"></i>
    <span layout:fragment="text-icon" class="logo__text">Daftar Kelas </span>

    <section layout:fragment="content">
        <!-- Modal -->
        <div class="modal fade" id="modalAddKelas" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Form Tambah Kelas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <form id="modalForm">
                            <label for="kelas_name" class="form-label">Name : </label>
                            <input id="kelas_name" type="text" class="form-control" placeholder="Kelas Name" />
                            <label for="kelas_tipe" class="form-label">Type : </label>
                            <input id="kelas_tipe" type="text" class="form-control" placeholder="Kelas Tipe" />
                            <label for="silabus_id" class="form-label">Silabus : </label>
                            <select id="silabus_id" class="form-select">

                            </select>
                            <label for="kelas_startDate" class="form-label">Start Date : </label>
                            <input id="kelas_startDate" type="date" class="form-control" placeholder="Kelas Name" />
                            <label for="kelas_endDate" class="form-label">End Date : </label>
                            <input id="kelas_endDate" type="date" class="form-control" placeholder="Kelas Name" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="submitModal">Simpan</button>
                    </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Update Modal -->
        <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateModalLabel">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="updateForm">
                            <input type="hidden" id="updateId">
                            <label for="updateTipe" class="form-label">Type : </label>
                            <input id="updateTipe" type="text" class="form-control" placeholder="Kelas Tipe" />
                            <label for="update_silabus" class="form-label">Silabus : </label>
                            <select id="update_silabus" class="form-select">

                            </select>
                            <label for="update_startDate" class="form-label">Start Date : </label>
                            <input id="update_startDate" type="date" class="form-control" />
                            <label for="update_endDate" class="form-label">End Date : </label>
                            <input id="update_endDate" type="date" class="form-control" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="submitUpdateModal">Simpan</button>
                    </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="container table__container">
            <div class="row table__wrapper">
                <!-- Create Modal -->
                <div class="button__wrapper">
                    <button type="button" class="btn btn-primary ms-2 btn-add" data-bs-toggle="modal"
                        data-bs-target="#modalAddKelas">
                        Tambah Kelas
                    </button>
                </div>
                <table class="table table-striped" id="tabel_kelas">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Tipe</th>
                            <th>Silabus</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>


    </section>

    <script layout:fragment="scripts">

        $(document).ready(function () {
            getAllSilabus();
        });
        //Inisialisasi data table dengan ajax
        var tb = $('#tabel_kelas').DataTable({
            ajax: {
                url: '/kelas/getAll',
                dataSrc: 'data'
            },
            columns: [
                { data: 'id' },
                { data: 'tipe' },
                { data: 'silabus.name' },
                { data: 'startDate' },
                { data: 'endDate' },
                {
                    data: null,
                    render: function (data, type, row, meta) {
                        return `<a class="btn btn-sm btn-primary ms-2"
                       href='/kelas/${data.id}'>
               Detail
                  </a>
                        <button type="button" class="btn btn-sm btn-success ms-2" id="btnEditModal" data-bs-toggle="modal" data-bs-target="#updateModal"
              onclick="getDataById('${data.id}')">
               Update
                  </button>
                    <button class="btn btn-sm btn-danger" id="deleteBtn" type="button" onclick="deleteById('${data.id}')">Delete</button>`;
                    }
                }
            ],
            "filter": false,
            "ordering": false,
            "lengthChange": false,
            "language": {
                "info": "_START_ - _END_ of _TOTAL_ items",
                "infoEmpty": "0 to 0 of 0 items",
                "infoFiltered": "(filtered from _MAX_ items)",
            }
        });



        //Aksi ketika create
        $('#submitModal').click((e) => {
            e.preventDefault();
            var kelas_name = $('#kelas_name').val();
            var kelas_tipe = $('#kelas_tipe').val();
            var kelas_silabus = $('#silabus_id').val();
            var kelas_startDate = $('#kelas_startDate').val();
            var kelas_endDate = $('#kelas_endDate').val();
            if (kelas_name) {
                if (kelas_tipe) {
                    if (kelas_startDate) {
                        if (kelas_endDate) {
                            $.ajax({
                                type: "POST",
                                url: "/kelas/create",
                                dataType: "json",
                                data: JSON.stringify({
                                    id: kelas_name,
                                    tipe: kelas_tipe,
                                    silabusId: kelas_silabus,
                                    startDate: kelas_startDate,
                                    endDate: kelas_endDate
                                }),
                                contentType: "application/json",
                                success: function (result) {
                                    $('#modalAddKelas').modal("hide");
                                    $('.modal-backdrop').remove();
                                    tb.ajax.reload();
                                    customSweetAlert(result.message);
                                }
                            });
                        }
                        else {
                            errorSweetAlert('You are missing Kelas End Date.');
                        }
                    }
                    else {
                        errorSweetAlert('You are missing Kelas Start Date.');
                    }
                }
                else {
                    errorSweetAlert('You are missing Kelas Tipe.');
                }
            } else {
                errorSweetAlert('You are missing Kelas Name.');
            }
        });

        //aksi ketika update
        $('#submitUpdateModal').click((e) => {
            e.preventDefault();

            var kelas_id = $('#updateId').val();
            var kelas_tipe = $('#updateTipe').val();
            var kelas_silabus = $('#update_silabus').val();
            var kelas_startDate = $('#update_startDate').val();
            var kelas_endDate = $('#update_endDate').val();

                if (kelas_tipe) {
                    if (kelas_startDate) {
                        if (kelas_endDate) {
                            $.ajax({
                                type: "PUT",
                                url: "/kelas/update/" + kelas_id,
                                dataType: "json",
                                data: JSON.stringify({
                                    tipe: kelas_tipe,
                                    silabusId: kelas_silabus,
                                    startDate: kelas_startDate,
                                    endDate: kelas_endDate
                                }),
                                contentType: "application/json",
                                success: function (result) {
                                    $('#updateModal').modal("hide");
                                    $('.modal-backdrop').remove();
                                    tb.ajax.reload();
                                    customSweetAlert(result.message);
                                }
                            });
                        }
                        else {
                            errorSweetAlert('You are missing Kelas End Date.');
                        }
                    }
                    else {
                        errorSweetAlert('You are missing Kelas Start Date.');
                    }
                }
                else {
                    errorSweetAlert('You are missing Kelas Tipe.');
                }
        });


        function getAllSilabus() {
            $.ajax({
                type: "GET",
                url: "/silabus/getAll",
                data: "data",
                dataType: "json",
                success: function (response) {
                    let row = "";
                    response.data.forEach(data => {
                        row += `
                        <option value=${data.id}>${data.name}</option>
                        `
                    });
                    $('#silabus_id').append(row);
                    $('#update_silabus').append(row);

                }
            });
        }

        function deleteById(id) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showDenyButton: true,
                confirmButtonColor: '#3085d6',
                denyButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!',
                denyButtonText: 'Batalkan'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteData('/kelas/delete/' + id);
                } else if (result.isDenied) {
                    Swal.fire(
                        'Canceled!',
                        'Your data has not been deleted.',
                        'success'
                    )
                }
            })
        }

        function getDataById(id) {
            $.ajax({
                type: "GET",
                url: "/kelas/detail_ajax/" + id,
                dataType: "JSON",
                success: function (response) {
                    var x = response.data;
                    $("#updateId").val(x.id);
                    $("#updateTipe").val(x.tipe);
                    $("#update_silabus").val(x.silabus.id);
                    $("#update_startDate").val(x.startDate);
                    $("#update_endDate").val(x.endDate);
                },
            });
        }

        function deleteData(end_point) {
            $.ajax({
                type: "DELETE",
                url: end_point,
                dataType: "json",
                success: function (result) {
                    $('#updateModal').modal("hide");
                    tb.ajax.reload();
                    customSweetAlert(result.message);
                }
            });
        }

        function customSweetAlert(msg) {
            Swal.fire(
                'Status Action?',
                msg,
                'success'
            ).then(() => {
                $("body").removeAttr("style");
            });
        }

        function errorSweetAlert(msg) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: msg
            })
        }

    </script>
</body>


</html>